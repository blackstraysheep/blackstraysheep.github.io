<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>縦書き：はみ出し→扁平 / 余白→字間で両端揃え（自動）デモ</title>
<style>
  :root{
    --panel-w: 360px;
    --frame-w: 240px;
    --frame-h: 420px;
    --font-size: 28px;
  }
  *{ box-sizing: border-box; }
  body{
    margin:0; padding:24px;
    background:#f6f6f8; color:#222;
    font-family: system-ui, -apple-system, "Hiragino Sans", "ヒラギノ角ゴ ProN W3",
                 "Yu Gothic UI", "Yu Gothic", "Noto Sans JP", sans-serif;
  }
  h1{
    margin:0 0 16px; font-size:20px; font-weight:700;
    letter-spacing:.02em;
  }
  .container{
    display:grid; grid-template-columns: var(--panel-w) 1fr; gap:24px;
    align-items:start; max-width:1200px; margin:0 auto;
  }
  .panel{
    background:#fff; border:1px solid #e5e7ef; border-radius:14px;
    padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.06); position:sticky; top:16px;
  }
  .panel .row{ margin-bottom:14px; }
  .panel label{ display:block; font-size:12px; color:#555; margin-bottom:6px; }
  textarea{
    width:100%; height:140px; resize:vertical;
    border:1px solid #d7dae6; border-radius:10px; padding:10px 12px;
    font-size:14px; line-height:1.5; background:#fbfbfe;
    outline:none;
  }
  input[type="range"]{ width:100%; }
  .samples{
    display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;
  }
  .samples button{
    border:1px solid #d7dae6; background:#fff; border-radius:999px;
    padding:6px 10px; font-size:12px; cursor:pointer;
  }

  .stage{
    display:flex; gap:24px; flex-wrap:wrap; align-items:flex-start;
  }

  .frame{
    width:var(--frame-w); height:var(--frame-h);
    background: linear-gradient(180deg, #fff 0%, #f0f3ff 100%);
    border:1px solid #d8dbe8; border-radius:14px; padding:10px;
    position:relative; box-shadow:0 10px 30px rgba(26,33,68,.10);
    overflow:hidden;
  }
  /* 目安の内側ガイド */
  .frame::before{
    content:""; position:absolute; inset:10px; border:1px dashed #c9cde0;
    border-radius:10px; pointer-events:none;
  }
  /* 上下の目盛りライン（視覚的に両端がわかるように） */
  .frame .ticks{
    position:absolute; left:10px; right:10px; top:10px; bottom:10px; pointer-events:none;
    background:
      linear-gradient(to bottom, transparent 0, transparent calc(100% - 1px), #b8bfd9 calc(100% - 1px)),
      linear-gradient(to top,    transparent 0, transparent calc(100% - 1px), #b8bfd9 calc(100% - 1px));
    background-size: 100% 100%, 100% 100%;
  }

  /* 縦書き本文 */
  .vertical{
    writing-mode: vertical-rl;
  text-orientation: mixed;   /* 日本語は縦中横を使わないならuprightでOK。英数を寝かせたいなら 'mixed' に */
    white-space: nowrap;         /* 1カラム固定（改行は無視） */
    line-height: 1;              /* 余計な行間はゼロ基準にしておく */
    display:inline-block;
    transform-origin: top right; /* 上端合わせでスケール（扁平） */
    font-size: var(--font-size);
    /* letter-spacing と transform はJSで動的に設定 */
  }

  /* モード表示バッジ */
  .badge{
    position:absolute; left:14px; top:14px; z-index:2;
    padding:6px 10px; font-size:12px; border-radius:999px;
    background:#eaf6ff; color:#0366d6; border:1px solid #cfe9ff;
    font-weight:600;
  }
  .badge.scale{ background:#fff4ec; color:#a45400; border-color:#ffd8b4; }
  .badge.justify{ background:#e7f8ef; color:#0a7f41; border-color:#bfead1; }

  .readout{
    margin-top:8px; font-size:12px; color:#555;
  }

  .note{
    font-size:12px; color:#666; margin-top:10px;
  }

  /* 調整しやすいようにレスポンシブ */
  @media (max-width: 980px){
    :root{ --panel-w: 100%; }
    .container{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>縦書き：はみ出し→扁平 / 余白→字間で両端揃え（自動）</h1>

      <div class="row">
        <label for="text">テキスト（※改行は1カラムの都合で無視）</label>
        <textarea id="text">夏草や兵どもが夢の跡
古池や蛙飛び込む水の音
閑さや岩にしみ入る蝉の声</textarea>
        <div class="samples">
          <button type="button" data-sample="古池や蛙飛び込む水の音">短文</button>
          <button type="button" data-sample="夏草や兵どもが夢の跡">中くらい</button>
          <button type="button" data-sample="五月雨をあつめて早し最上川　奥の細道の旅情ここに極まれりと人はいふ。されども、風の便りのごとくはかなく過ぎゆくもまた一興。">長め</button>
        </div>
      </div>

      <div class="row">
        <label>短冊の高さ（px）</label>
        <input id="h" type="range" min="180" max="720" step="2" value="420" />
      </div>

      <div class="row">
        <label>フォントサイズ（px）</label>
        <input id="fs" type="range" min="16" max="56" step="1" value="28" />
      </div>

      <div class="row">
        <label>（参考）現在のモード／各種値</label>
        <div id="readout" class="readout">—</div>
        <div class="note">※1カラム固定のため、はみ出す場合は縦方向scale（扁平）。余りがある場合は letter-spacing で上下端ぴったりに伸長します。</div>
      </div>
    </div>

    <div>
      <div class="stage">
        <div id="frame" class="frame" aria-label="短冊">
          <div id="badge" class="badge">—</div>
          <div class="ticks"></div>
          <span id="content" class="vertical"></span>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (sel) => document.querySelector(sel);
  const frame = $('#frame');
  const content = $('#content');
  const badge = $('#badge');
  const readout = $('#readout');
  const textArea = $('#text');
  const heightRange = $('#h');
  const fsRange = $('#fs');

  // 初期反映
  const init = () => {
    document.documentElement.style.setProperty('--frame-h', heightRange.value + 'px');
    document.documentElement.style.setProperty('--font-size', fsRange.value + 'px');
    layout();
  };

  // 文字列から改行を取り、前後空白は削る（1カラム運用のため）
  const normalize = (s) => s.replace(/\r?\n/g, '').trim();

  // レイアウトの主処理
  const layout = () => {
    const text = normalize(textArea.value);
    content.style.letterSpacing = '0px';
    content.style.transform = 'none';
    content.textContent = text || '（テキスト未入力）';

    // 利用可能な縦方向の内寸（paddingを除外）
    const cs = getComputedStyle(frame);
    const available = frame.clientHeight
                    - parseFloat(cs.paddingTop)
                    - parseFloat(cs.paddingBottom);

    // 文字数（サロゲートペア対応）
    const charCount = Array.from(text).length;

    // 現在（字間0・スケール無し）の高さ
    const h0 = content.getBoundingClientRect().height;

    let mode = '';
    let scale = 1;
    let spacing = 0;

    if (h0 > available + 0.5) {
      // はみ出し → 縦方向に圧縮（扁平）
      scale = available / h0;
      content.style.transform = `scaleY(${scale})`;
      mode = 'scale';
      badge.textContent = `モード: 扁平（scaleY = ${scale.toFixed(3)}）`;
      badge.classList.remove('justify'); badge.classList.add('scale');

    } else {
      // 余り → letter-spacing で上下端ぴったり
      if (charCount > 1) {
        const gaps = charCount - 1;
        spacing = (available - h0) / gaps;
        content.style.letterSpacing = `${spacing}px`;

        // 反映後の微調整（丸め誤差で±1pxずれることがある）
        const h1 = content.getBoundingClientRect().height;
        if (Math.abs(h1 - available) > 0.5 && h1 > 0) {
          const adjust = available / h1;
          spacing = spacing * adjust;
          content.style.letterSpacing = `${spacing}px`;
        }
      } else {
        spacing = 0;
        content.style.letterSpacing = '0px';
      }
      mode = 'justify';
      badge.textContent = `モード: 字間調整（両端揃え）`;
      badge.classList.remove('scale'); badge.classList.add('justify');
    }

    // 読み取り用の数値
    const hNow = content.getBoundingClientRect().height;
    readout.innerHTML =
      `高さ: 使用 ${hNow.toFixed(1)} px / 枠 ${available.toFixed(1)} px` +
      `｜文字数: ${charCount}` +
      `｜letter-spacing: ${spacing.toFixed(2)} px` +
      `｜scaleY: ${scale.toFixed(3)}` +
      `｜モード: ${mode === 'scale' ? '扁平' : '字間調整'}`;
  };

  // 操作イベント
  textArea.addEventListener('input', layout);
  heightRange.addEventListener('input', (e) => {
    document.documentElement.style.setProperty('--frame-h', e.target.value + 'px');
    layout();
  });
  fsRange.addEventListener('input', (e) => {
    document.documentElement.style.setProperty('--font-size', e.target.value + 'px');
    layout();
  });

  // サンプル文セット
  document.querySelectorAll('.samples button').forEach(btn => {
    btn.addEventListener('click', () => {
      textArea.value = btn.getAttribute('data-sample');
      layout();
    });
  });

  // リサイズにも追随
  window.addEventListener('resize', () => {
    // レイアウト負荷を下げるためにrequestAnimationFrameで1フレーム遅延
    window.requestAnimationFrame(layout);
  });

  init();
})();
</script>
</body>
</html>
